<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sog'lik Statistika</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --secondary: #3b82f6;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #ffffff;
            --surface: #f9fafb;
            --text: #1f2937;
            --text-light: #6b7280;
            --border: #e5e7eb;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            padding-bottom: 0;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }

        /* Header - Compact Mode */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 15px 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header.compact {
            padding: 10px 20px;
        }

        .days-counter {
            font-size: 48px;
            font-weight: bold;
            line-height: 1;
            margin: 5px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .time-detail {
            font-size: 14px;
            opacity: 0.9;
            margin: 3px 0;
        }

        .milestone {
            font-size: 13px;
            opacity: 0.85;
            margin-top: 5px;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 5px;
            cursor: pointer;
            transition: all 0.3s;
            border-top: 3px solid transparent;
        }

        .nav-item.active {
            color: var(--primary);
            border-top-color: var(--primary);
        }

        .nav-item i {
            font-size: 24px;
            display: block;
            margin-bottom: 4px;
        }

        .nav-item span {
            font-size: 11px;
            display: block;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            padding: 15px;
            padding-bottom: 150px;
            animation: fadeIn 0.3s;
            min-height: calc(100vh - 180px);
        }

        .tab-content.active {
            display: block;
        }

        /* Timeline */
        .timeline {
            position: relative;
            padding-left: 40px;
        }

        .timeline-item {
            position: relative;
            padding: 15px 0;
            border-left: 3px solid var(--border);
        }

        .timeline-item.completed {
            border-left-color: var(--success);
        }

        .timeline-item.current {
            border-left-color: var(--warning);
        }

        .timeline-icon {
            position: absolute;
            left: -15px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            background: white;
            border: 3px solid var(--border);
        }

        .timeline-item.completed .timeline-icon {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .timeline-item.current .timeline-icon {
            background: var(--warning);
            border-color: var(--warning);
            color: white;
            animation: pulse 2s infinite;
        }

        .timeline-content {
            padding-left: 20px;
        }

        .timeline-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .timeline-desc {
            color: var(--text-light);
            font-size: 14px;
            line-height: 1.4;
        }

        .timeline-time {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 5px;
        }

        /* Achievements */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .achievement-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 2px solid var(--border);
        }

        .achievement-card.unlocked {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #f59e0b;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .achievement-card.unlocked:hover {
            transform: translateY(-5px);
        }

        .achievement-icon {
            font-size: 48px;
            margin-bottom: 10px;
            display: block;
        }

        .achievement-card.locked .achievement-icon {
            filter: grayscale(1);
            opacity: 0.4;
        }

        .achievement-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .achievement-desc {
            font-size: 12px;
            color: var(--text-light);
        }

        .achievement-progress {
            margin-top: 10px;
            font-size: 12px;
            color: var(--primary);
            font-weight: bold;
        }

        /* Goals */
        .goal-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .goal-icon {
            font-size: 32px;
        }

        .goal-price {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary);
        }

        .goal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 24px;
            background: #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--success) 100%);
            transition: width 1s ease-out;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .goal-remaining {
            margin-top: 8px;
            font-size: 14px;
            color: var(--text-light);
        }

        /* Chart Container */
        .chart-container {
            background: var(--surface);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        /* Challenges */
        .challenge-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
            cursor: pointer;
            transition: all 0.3s;
            user-select: none;
        }

        .challenge-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .challenge-card:active {
            transform: scale(0.98);
        }

        .challenge-card.completed {
            opacity: 0.8;
            border-left-color: var(--success);
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }

        .challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .challenge-title {
            font-size: 16px;
            font-weight: bold;
        }

        .challenge-status {
            font-size: 24px;
        }

        .challenge-desc {
            color: var(--text-light);
            font-size: 14px;
            margin-bottom: 10px;
        }

        .challenge-progress {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .challenge-bar {
            flex: 1;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
        }

        .challenge-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--success) 100%);
            transition: width 0.5s ease-out;
        }

        .challenge-counter {
            font-size: 14px;
            font-weight: bold;
            color: var(--primary);
            min-width: 50px;
            text-align: right;
        }

        .challenge-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .challenge-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .challenge-btn.increment {
            background: var(--primary);
            color: white;
        }

        .challenge-btn.increment:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .challenge-btn.decrement {
            background: var(--danger);
            color: white;
        }

        .challenge-btn.decrement:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .challenge-btn:active {
            transform: scale(0.95);
        }

        .challenge-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary);
            margin: 10px 0;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-light);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Section Headers */
        .section-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header compact" id="header">
        <div class="days-counter" id="days-counter">0</div>
        <div class="time-detail" id="time-detail">0 soat, 0 daqiqa</div>
        <div class="milestone" id="milestone">üéØ Maqsadga intilamiz</div>
    </div>

    <!-- Tab 1: Asosiy -->
    <div class="tab-content active" id="tab-home">
        <div class="section-header">‚è∞ Sog'lik Timeline</div>
        <div class="timeline" id="timeline"></div>
    </div>

    <!-- Tab 2: Statistika -->
    <div class="tab-content" id="tab-stats">
        <div class="section-header">üìä Progress Grafik</div>
        <div class="chart-container">
            <canvas id="progressChart"></canvas>
        </div>
        
        <div class="section-header">üí™ Sog'lik Ko'rsatkichlari</div>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">ü´Å Nikotin</div>
                <div class="stat-value" id="stat-nicotine">0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">üå¨Ô∏è Nafas</div>
                <div class="stat-value" id="stat-breathing">0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">‚ù§Ô∏è Pulse</div>
                <div class="stat-value" id="stat-pulse">0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">üí™ Umumiy</div>
                <div class="stat-value" id="stat-overall">0%</div>
            </div>
        </div>
    </div>

    <!-- Tab 3: Achievements -->
    <div class="tab-content" id="tab-achievements">
        <div class="section-header">üèÜ Yutuqlaringiz</div>
        <div class="achievements-grid" id="achievements-grid"></div>
    </div>

    <!-- Tab 4: Maqsadlar -->
    <div class="tab-content" id="tab-goals">
        <div class="section-header">üí∞ Tejalgan Pul</div>
        <div class="stat-card" style="margin-bottom: 20px;">
            <div class="stat-value" id="saved-money" style="font-size: 48px;">0 so'm</div>
            <div class="stat-label">Jami tejalgan</div>
        </div>

        <div class="section-header">üéØ Xarid Rejalari</div>
        <div id="goals-list"></div>
    </div>

    <!-- Tab 5: Challenges -->
    <div class="tab-content" id="tab-challenges">
        <div class="section-header">üéØ Bugungi Vazifalar</div>
        <div id="challenges-list"></div>
        
        <div class="section-header" style="margin-top: 30px;">üî• Streak</div>
        <div class="stat-card">
            <div class="stat-value" id="streak-days">0</div>
            <div class="stat-label">Ketma-ket kunlar</div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('home')">
            <i class="fas fa-home"></i>
            <span>Asosiy</span>
        </div>
        <div class="nav-item" onclick="switchTab('stats')">
            <i class="fas fa-chart-line"></i>
            <span>Statistika</span>
        </div>
        <div class="nav-item" onclick="switchTab('achievements')">
            <i class="fas fa-trophy"></i>
            <span>Yutuqlar</span>
        </div>
        <div class="nav-item" onclick="switchTab('goals')">
            <i class="fas fa-bullseye"></i>
            <span>Maqsadlar</span>
        </div>
        <div class="nav-item" onclick="switchTab('challenges')">
            <i class="fas fa-fire"></i>
            <span>Vazifalar</span>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        
        // Full screen mode
        tg.setHeaderColor('#10b981');
        tg.setBackgroundColor('#ffffff');
        
        // Disable vertical swipes (optional)
        tg.disableVerticalSwipes();

        let userData = null;
        let progressChart = null;

        // Get data from URL
        function getData() {
            const urlParams = new URLSearchParams(window.location.search);
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            
            let dataParam = params.get('data') || urlParams.get('data');
            
            if (dataParam) {
                try {
                    const decoded = decodeURIComponent(dataParam);
                    return JSON.parse(decoded);
                } catch (e) {
                    try {
                        const decoded = atob(dataParam);
                        return JSON.parse(decoded);
                    } catch (e2) {
                        console.error('Error decoding data:', e2);
                        return null;
                    }
                }
            }
            return null;
        }

        // Switch Tab
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // Timeline Data
        const timelineData = [
            { time: '20 daqiqa', title: 'Pulse normalashdi', desc: 'Yurak urish tezligi normal holatga keldi', icon: '‚ù§Ô∏è', hours: 0.33 },
            { time: '8 soat', title: 'Karbon monoksid yo\'q', desc: 'Qondagi karbon monoksid darajasi normallashdi', icon: 'üå¨Ô∏è', hours: 8 },
            { time: '24 soat', title: 'Infarkt xavfi kamaydi', desc: 'Yurak xuruj xavfi pasaya boshladi', icon: 'üíö', hours: 24 },
            { time: '48 soat', title: 'Tam va hid qaytdi', desc: 'Nerv uchlari tiklanmoqda', icon: 'üëÉ', hours: 48 },
            { time: '72 soat', title: 'Nikotin yo\'q', desc: 'Tanadan nikotin to\'liq chiqdi', icon: 'ü´Å', hours: 72 },
            { time: '2 hafta', title: 'Nafas oson', desc: 'O\'pka faoliyati 30% yaxshilandi', icon: 'üå¨Ô∏è', hours: 336 },
            { time: '1 oy', title: 'Energiya ko\'paydi', desc: 'Jismoniy chidamlilik oshdi', icon: '‚ö°', hours: 720 },
            { time: '3 oy', title: 'O\'pka yaxshilandi', desc: 'O\'pka funksiyasi sezilarli darajada oshdi', icon: 'ü´Å', hours: 2160 },
            { time: '6 oy', title: 'Yo\'tal kamaydi', desc: 'Bronxlar tozalandi', icon: 'üòä', hours: 4320 },
            { time: '1 yil', title: 'Yurak xavfi -50%', desc: 'Yurak-qon tomir kasalliklari xavfi 2 barobar kamaydi', icon: '‚ù§Ô∏è', hours: 8760 },
            { time: '5 yil', title: 'Insult xavfi normal', desc: 'Insult xavfi chekmaydigan odamlar darajasida', icon: 'üß†', hours: 43800 },
            { time: '10 yil', title: 'O\'pka saratoni -50%', desc: 'O\'pka saratoni xavfi 2 barobar kamaydi', icon: 'üèÜ', hours: 87600 }
        ];

        // Achievements Data
        const achievementsData = [
            { id: 1, days: 0, icon: 'üéØ', title: 'Boshlash', desc: 'Birinchi qadam' },
            { id: 2, days: 1, icon: 'üåü', title: 'Birinchi kun', desc: '24 soat o\'tdi' },
            { id: 3, days: 3, icon: 'üíé', title: 'Nikotin yo\'q', desc: '72 soat temiz' },
            { id: 4, days: 7, icon: 'üèÖ', title: 'Bir hafta', desc: '7 kun muvaffaqiyat' },
            { id: 5, days: 14, icon: '‚≠ê', title: 'Ikki hafta', desc: 'Zo\'r natija!' },
            { id: 6, days: 30, icon: 'üëë', title: 'Bir oy', desc: 'Siz champion!' },
            { id: 7, days: 60, icon: 'üéñÔ∏è', title: 'Ikki oy', desc: 'Ajoyib!' },
            { id: 8, days: 90, icon: 'üèÜ', title: 'Uch oy', desc: 'Afsona!' },
            { id: 9, days: 180, icon: 'üí™', title: 'Olti oy', desc: 'Kuchli!' },
            { id: 10, days: 365, icon: 'üéä', title: 'BIR YIL!', desc: 'G\'olib!' }
        ];

        // Goals Data
        const goalsData = [
            { id: 1, icon: 'üì±', title: 'iPhone 15 Pro', price: 12000000 },
            { id: 2, icon: '‚úàÔ∏è', title: 'Turkiyaga sayohat', price: 8000000 },
            { id: 3, icon: 'üíª', title: 'MacBook Pro', price: 15000000 },
            { id: 4, icon: 'üöó', title: 'Mashina (to\'lov)', price: 50000000 },
            { id: 5, icon: 'üè†', title: 'Uy jihozlari', price: 5000000 }
        ];

        // Challenges Data
        const challengesData = [
            { id: 1, title: '10 daqiqa yurish', desc: 'Har kuni kamida 10 daqiqa yuring', icon: 'üö∂', target: 1, unit: 'marta' },
            { id: 2, title: '5 stakan suv', desc: 'Kuniga 5 stakan suv iching', icon: 'üíß', target: 5, unit: 'stakan' },
            { id: 3, title: '10 ta chuqur nafas', desc: 'Stress kamayishi uchun', icon: 'üßò', target: 10, unit: 'marta' },
            { id: 4, title: 'Meva yeyish', desc: '1 ta meva yoki sabzavot', icon: 'üçé', target: 1, unit: 'marta' },
            { id: 5, title: 'Erta uxlash', desc: '22:00 dan oldin uxlang', icon: 'üò¥', target: 1, unit: 'marta' }
        ];

        // Render Timeline
        function renderTimeline(hours) {
            const container = document.getElementById('timeline');
            container.innerHTML = '';
            
            timelineData.forEach(item => {
                const div = document.createElement('div');
                div.className = 'timeline-item';
                
                if (hours >= item.hours) {
                    div.classList.add('completed');
                } else if (hours >= item.hours * 0.5) {
                    div.classList.add('current');
                }
                
                const timeRemaining = item.hours > hours ? 
                    `${Math.round(item.hours - hours)} soat qoldi` : 
                    'Bajarildi!';
                
                div.innerHTML = `
                    <div class="timeline-icon">${item.icon}</div>
                    <div class="timeline-content">
                        <div class="timeline-title">${item.title}</div>
                        <div class="timeline-desc">${item.desc}</div>
                        <div class="timeline-time">${item.time} - ${timeRemaining}</div>
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        // Render Achievements
        function renderAchievements(days) {
            const container = document.getElementById('achievements-grid');
            container.innerHTML = '';
            
            achievementsData.forEach(ach => {
                const div = document.createElement('div');
                div.className = 'achievement-card';
                
                const unlocked = days >= ach.days;
                if (unlocked) {
                    div.classList.add('unlocked');
                }
                
                const progress = unlocked ? '‚úÖ Ochildi' : `${ach.days - days} kun qoldi`;
                
                div.innerHTML = `
                    <div class="achievement-icon">${ach.icon}</div>
                    <div class="achievement-title">${ach.title}</div>
                    <div class="achievement-desc">${ach.desc}</div>
                    <div class="achievement-progress">${progress}</div>
                `;
                
                container.appendChild(div);
            });
        }

        // Render Goals
        function renderGoals(savedMoney) {
            const container = document.getElementById('goals-list');
            container.innerHTML = '';
            
            goalsData.forEach(goal => {
                const progress = Math.min(100, (savedMoney / goal.price) * 100);
                const remaining = Math.max(0, goal.price - savedMoney);
                
                const div = document.createElement('div');
                div.className = 'goal-card';
                
                div.innerHTML = `
                    <div class="goal-header">
                        <div class="goal-icon">${goal.icon}</div>
                        <div class="goal-price">${goal.price.toLocaleString('uz-UZ')} so'm</div>
                    </div>
                    <div class="goal-title">${goal.title}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%">${Math.round(progress)}%</div>
                    </div>
                    <div class="goal-remaining">
                        ${remaining > 0 ? 
                            `Yana ${remaining.toLocaleString('uz-UZ')} so'm kerak` : 
                            '‚úÖ Maqsadga erishdingiz!'}
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        // Render Challenges
        function renderChallenges() {
            const container = document.getElementById('challenges-list');
            container.innerHTML = '';
            
            // Get today's progress from localStorage
            const today = new Date().toDateString();
            const storageKey = 'challenges_' + today;
            const progressData = JSON.parse(localStorage.getItem(storageKey) || '{}');
            
            challengesData.forEach(challenge => {
                const current = progressData[challenge.id] || 0;
                const progress = Math.min(100, (current / challenge.target) * 100);
                const completed = current >= challenge.target;
                
                const div = document.createElement('div');
                div.className = 'challenge-card';
                if (completed) div.classList.add('completed');
                
                div.innerHTML = `
                    <div class="challenge-header">
                        <div class="challenge-title">${challenge.icon} ${challenge.title}</div>
                        <div class="challenge-status">${completed ? '‚úÖ' : '‚è≥'}</div>
                    </div>
                    <div class="challenge-desc">${challenge.desc}</div>
                    <div class="challenge-progress">
                        <div class="challenge-bar" onclick="incrementChallenge(${challenge.id})">
                            <div class="challenge-bar-fill" style="width: ${progress}%"></div>
                        </div>
                        <span class="challenge-counter">${current}/${challenge.target}</span>
                    </div>
                    <div class="challenge-actions">
                        <button class="challenge-btn increment" onclick="incrementChallenge(${challenge.id})" ${completed ? 'disabled' : ''}>
                            ‚ûï Bajarildi
                        </button>
                        <button class="challenge-btn decrement" onclick="decrementChallenge(${challenge.id})" ${current === 0 ? 'disabled' : ''}>
                            ‚ûñ Bekor
                        </button>
                    </div>
                `;
                
                container.appendChild(div);
            });
            
            // Update streak
            updateStreak();
        }
        
        // Increment challenge
        function incrementChallenge(challengeId) {
            const today = new Date().toDateString();
            const storageKey = 'challenges_' + today;
            const progressData = JSON.parse(localStorage.getItem(storageKey) || '{}');
            
            // Find challenge
            const challenge = challengesData.find(c => c.id === challengeId);
            if (!challenge) return;
            
            // Get current progress
            const current = progressData[challengeId] || 0;
            
            // Don't increment if already completed
            if (current >= challenge.target) return;
            
            // Increment
            progressData[challengeId] = current + 1;
            
            // Save
            localStorage.setItem(storageKey, JSON.stringify(progressData));
            
            // Vibrate (if supported)
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
            
            // Re-render
            renderChallenges();
            
            // Show confetti if completed
            if (progressData[challengeId] >= challenge.target) {
                showCompletionAnimation(challengeId);
            }
        }
        
        // Decrement challenge
        function decrementChallenge(challengeId) {
            const today = new Date().toDateString();
            const storageKey = 'challenges_' + today;
            const progressData = JSON.parse(localStorage.getItem(storageKey) || '{}');
            
            // Get current progress
            const current = progressData[challengeId] || 0;
            
            // Don't decrement if already 0
            if (current <= 0) return;
            
            // Decrement
            progressData[challengeId] = current - 1;
            
            // Save
            localStorage.setItem(storageKey, JSON.stringify(progressData));
            
            // Vibrate
            if (navigator.vibrate) {
                navigator.vibrate(30);
            }
            
            // Re-render
            renderChallenges();
        }
        
        // Show completion animation
        function showCompletionAnimation(challengeId) {
            // Simple alert for now
            const challenge = challengesData.find(c => c.id === challengeId);
            if (challenge) {
                setTimeout(() => {
                    alert(`üéâ Tabriklayman! "${challenge.title}" bajarildi!`);
                }, 300);
            }
        }
        
        // Update streak
        function updateStreak() {
            // Calculate streak based on completed days
            const streakDays = calculateStreak();
            document.getElementById('streak-days').textContent = streakDays;
        }
        
        // Calculate streak
        function calculateStreak() {
            let streak = 0;
            let currentDate = new Date();
            
            // Check last 30 days
            for (let i = 0; i < 30; i++) {
                const dateStr = currentDate.toDateString();
                const storageKey = 'challenges_' + dateStr;
                const progressData = JSON.parse(localStorage.getItem(storageKey) || '{}');
                
                // Check if at least 3 challenges completed
                let completedCount = 0;
                challengesData.forEach(challenge => {
                    const current = progressData[challenge.id] || 0;
                    if (current >= challenge.target) {
                        completedCount++;
                    }
                });
                
                if (completedCount >= 3) {
                    streak++;
                } else if (i > 0) {
                    // Streak broken
                    break;
                }
                
                // Go to previous day
                currentDate.setDate(currentDate.getDate() - 1);
            }
            
            return streak;
        }

        // Render Progress Chart
        function renderChart(days) {
            const ctx = document.getElementById('progressChart').getContext('2d');
            
            // Generate data for last 7 days
            const labels = [];
            const data = [];
            
            for (let i = Math.max(0, days - 6); i <= days; i++) {
                labels.push(`${i} kun`);
                // Simulate health improvement curve
                const healthScore = Math.min(100, (i / 30) * 100);
                data.push(healthScore.toFixed(1));
            }
            
            if (progressChart) {
                progressChart.destroy();
            }
            
            progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Sog\'lik ko\'rsatkichi',
                        data: data,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Get milestone message
        function getMilestone(days) {
            const milestones = {
                365: "üèÖ 1 YIL - siz g'olibsiz!",
                180: "üéØ 6 oy - yurak xuruj xavfi 50% kamaydi!",
                90: "üíé 3 oy - afsona!",
                60: "‚≠ê 2 oy - sog'ligingiz sezilarli yaxshilandi!",
                30: "üëë 1 oy - siz champion!",
                14: "üåà 2 hafta - nafas olish yaxshilanmoqda!",
                7: "üèÜ 1 hafta - ajoyib!",
                3: "üéâ Nikotin 100% chiqdi!",
                1: "üåü Birinchi kun!",
                0: "üéØ Sayohatingiz boshlandi!"
            };

            for (let day of Object.keys(milestones).map(Number).sort((a, b) => b - a)) {
                if (days >= day) {
                    return milestones[day];
                }
            }
            return "üí™ Davom eting!";
        }

        // Initialize
        function init() {
            userData = getData();
            
            if (!userData) {
                document.body.innerHTML = '<div class="loading"><div class="spinner"></div><p>Ma\'lumotlar yuklanmoqda...</p></div>';
                return;
            }

            const days = userData.days || 0;
            const hours = userData.hours || 0;
            const minutes = userData.minutes || 0;
            
            // Header
            document.getElementById('days-counter').textContent = days;
            document.getElementById('time-detail').textContent = `${hours % 24} soat, ${minutes % 60} daqiqa`;
            document.getElementById('milestone').textContent = getMilestone(days);
            
            // Calculate saved money
            const savedMoney = days * (userData.cigarettes_per_day || 0) * ((userData.cigarette_price || 0) / 20);
            document.getElementById('saved-money').textContent = savedMoney.toLocaleString('uz-UZ') + ' so\'m';
            
            // Stats
            document.getElementById('stat-nicotine').textContent = (userData.stats?.nicotine_free || 0) + '%';
            document.getElementById('stat-breathing').textContent = (userData.stats?.breathing || 0) + '%';
            document.getElementById('stat-pulse').textContent = (userData.stats?.pulse || 0) + '%';
            document.getElementById('stat-overall').textContent = (userData.stats?.overall || 0) + '%';
            
            // Render components
            renderTimeline(hours);
            renderAchievements(days);
            renderGoals(savedMoney);
            renderChallenges();
            renderChart(days);
            
            // Streak (from challenges)
            updateStreak();
        }

        // Start
        init();
        
        // Auto-hide header on scroll
        let lastScroll = 0;
        let scrollTimer = null;
        
        window.addEventListener('scroll', () => {
            clearTimeout(scrollTimer);
            
            scrollTimer = setTimeout(() => {
                const currentScroll = window.pageYOffset;
                const header = document.getElementById('header');
                
                if (currentScroll > lastScroll && currentScroll > 100) {
                    // Scrolling down & passed 100px
                    header.style.transform = 'translateY(-100%)';
                    header.style.transition = 'transform 0.3s ease-in-out';
                } else {
                    // Scrolling up
                    header.style.transform = 'translateY(0)';
                }
                
                lastScroll = currentScroll;
            }, 50);
        });
    </script>
</body>
</html>
